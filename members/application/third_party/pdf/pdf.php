<?php
//Database Coonection

mysql_connect("localhost","autosist_autoweb","AutoSis@1#!") or die ("Could not connect to server");
mysql_select_db("autosist_autosis_webservices") or die("database is not connected");
 
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style type="text/css">

body{
	font-family:Arial, Helvetica, sans-serif;
	}

#footer {
    position: fixed;
    left: 0;
	right: 0;
	color: #000;
	font-size: 0.9em;
	font-family:Arial, Helvetica, sans-serif;
}

#footer {
  bottom: 3%;
 
}

#footer table {
	width: 100%;
	border-collapse: collapse;
	border: none;
}

.page-number {
  text-align: right;
  float:right;
}
.page-number:before {
  content:  counter(page);
}

img{
    width:auto;
    max-width:600px;
	max-height:600px;
}

</style>
  
</head>

<body>  


<div id="footer">
  <div class="page-number"></div>
  <table>
    <tr style="text-align:center">
      <td>This report was generated by AUTOsist<br/>
          <b style="color:#09F;">AUTOsist.com</b> - Managing your vehicle records just got easier</td>
    </tr>
  </table>
</div>
  
<?php
$Query  = "Select * From vechile Where id = '".$_REQUEST['vehicle_id']."' and email= '".$_REQUEST['email']."' ";
$result_vehicle = mysql_fetch_array( mysql_query( $Query ) ); 

$Vehicleimageids=$result_vehicle['image'];
$Vehicleimgids2=array();
$Vehicleimgids2 = explode(',',$Vehicleimageids);
$Vehicleimagescount=count($Vehicleimgids2);

$Query_second  = "Select * From receipt Where vecid = '".$_REQUEST['vehicle_id']."' and email= '".$_REQUEST['email']."'";
$qry_second  = mysql_query($Query_second ); 
$num_rows_second  = mysql_num_rows($qry_second);
// start of checking receipts exits

?>
     <div style="width: 95%; margin: auto; text-align:center; <?php if($Vehicleimagescount < 2 && $num_rows_second< 1){
	echo 'page-break-after: avoid';
	}else{ 
	echo 'page-break-after: always'; 
	} 
	?>
">
  
        <div style="margin:0 auto;"><img width="247" src="../img/main-logo.png" /></div>
        <div style="margin:0 auto; font-family:Arial, Helvetica, sans-serif; font-size:26px;"><h1>Receipt History Report</h1></div>
        	
        <div style="margin:0px auto 30px auto; font-family:Arial, Helvetica, sans-serif; font-weight:600; font-size:16px;"> 
		                  <?php 
					      if($result_vehicle['vechile_name']){
						  echo htmlspecialchars($result_vehicle['vechile_name']) ;
						  }else{
							 echo $result_vehicle['year']." ".$result_vehicle['make']." ".$result_vehicle['model'] ;  
							  }
						  ?>
                          </div>

                               
                        <?php
						   
						         $imageids=$result_vehicle['image'];	
								 $imgids=array();
								 $imgids2 = explode(',',$imageids);
								 
								 if( count($imgids2) > 1 )
								 {
								    $imgids = explode(',',$imageids);
								 
								 }
								 else
								 {
									 
									$imgids[0] = $result_vehicle['image']; 
								 }
								 
								
								    $vehicle_image_count=1;
									for($i=0;$i<count($imgids);$i++){
								
								    $fetch_images = mysql_query("SELECT  image.imagefile as image, image.Image_url as image_url, image.location as file_location 	FROM image  where Image_id= '$imgids[$i]'");
									 $row_image = mysql_fetch_array( $fetch_images ); 
									  $Image_Id=$imgids[$i];
									  $image=$row_image['image'];
									  $img_url=$row_image['image_url'];
								      $file_loc=$row_image['file_location'];
									 
									 if($image!=''||$img_url!=''||$file_loc!=''){
                                              $method="aes-256-cbc";
											  $key=12548693601;											  
																					
											  $decrypted = openssl_decrypt($image, $method, $key);
											  $decoded=base64_decode($decrypted);		
											  
											  $final_location = '../'.$img_url;
											 
											  file_put_contents($final_location, $decoded);

									          $final_location=$final_location;
											 
											 //start updating fetched images table
											 $query_result = mysql_query("SELECT * FROM Fetched_Image WHERE Image_Id=$Image_Id");
											 if($query_result){
												if (!mysql_num_rows($query_result))
												{
												   $tm = time();
												   mysql_query("INSERT INTO Fetched_Image (Image_Id, Image_Url, Time, location) VALUES ('$Image_Id ','$img_url ', $tm, '$file_loc')");
											  
												}
											 }// end updating fetched images table
											 
									 }else{
									 $final_location="../img/carproto.png";
									 }
									 ?>
                     
					 <?php if(count($imgids) > 1){
						 
						 
						 ?> 
                      
									 <?php if($vehicle_image_count == 1){ ?>  
                                     <table cellpadding="0" cellspacing="0" align="center" width="100%" style="height:650px;">
                     <tr>
                     <td valign="middle" align="center"> 
                                     <div style="margin: auto;"><img image="500" src="<?php echo $final_location; ?>" border="0"  /></div> </td></tr></table>
                                     </div>
                                     <?php } ?>
                                     
                                     <?php if($vehicle_image_count > 1&&$vehicle_image_count < count($imgids)){ ?>  
                                     <div style="width: 95%; margin: auto; text-align:center;  page-break-after: always;">
                                     <table cellpadding="0" cellspacing="0" align="center" width="100%" style="height:820px;">
                     <tr>
                     <td valign="middle" align="center"> 
                                     <div style="margin: auto;"><img  src="<?php echo $final_location; ?>"  border="0"  /></div> </td></tr></table>
                                     </div>
                                     <?php } ?>
                                     
                                     
                                     <?php if($vehicle_image_count > 1&&$vehicle_image_count == count($imgids)){ ?>  
                                     <div style="width: 95%; margin: auto; text-align:center;   <?php if($num_rows_second< 1){
	echo 'page-break-after: avoid';
	}else{ 
	echo 'page-break-after: always'; 
	} 
	?>">
    <table cellpadding="0" cellspacing="0" align="center" width="100%" style="height:900px;">
                     <tr>
                     <td valign="middle" align="center"> 
                                     <div style="margin: auto;"><img  src="<?php echo $final_location; ?>"  border="0"  /></div> <br /><br /><br />
                                     <div style="margin: 0px 70px; text-align:left; font-family:Arial, Helvetica, sans-serif; font-weight:600; font-size:20px;">Miles: <?php echo $result_vehicle['milage']; ?> </div> 
                                     <br />
                                     <br />
                                     <div style="margin: 0px 70px; text-align:left; font-family:Arial, Helvetica, sans-serif; font-weight:600; font-size:20px;">Vin #: <?php 									 
									    $method="aes-256-cbc";
										$key=12548693601;	
										$details1 = openssl_decrypt($result_vehicle['vin'], $method, $key);
										$details1 = htmlspecialchars_decode($details1);
										$details1 = stripcslashes($details1); 
										$details1 = str_replace("\'","'",$details1);
										$details1 = str_replace("\\\\","\\",$details1);					
										echo $details1;
									 ?></div>
                                     </td></tr>
                                     </table> 
                                     </div>
                                     <?php } ?>
                                    
                     <?php }else if(count($imgids) == 1||count($imgids)==0){  ?>
									<div style="margin: auto; "><img src="<?php echo $final_location; ?>"  border="0"  /></div> 
                                    <div style="margin: 30px 150px; text-align:left; font-family:Arial, Helvetica, sans-serif; font-weight:600; font-size:20px;">Miles: <?php    echo	$result_vehicle['milage']; ?> 
                                    </div> 
                                    <div style="margin: 0px 150px; text-align:left; font-family:Arial, Helvetica, sans-serif; font-weight:600; font-size:20px;">Vin #: <?php 
								 $method="aes-256-cbc";
								 $key=12548693601;	
					             $details1 = openssl_decrypt($result_vehicle['vin'], $method, $key);
								 $details1 = htmlspecialchars_decode($details1);
								 $details1 = stripcslashes($details1); 
								 $details1 = str_replace("\'","'",$details1);
								 $details1 = str_replace("\\\\","\\",$details1);					
								 echo $details1;
									 ?>
                                     </div> 
                                     </div>
					 <?php }?>   
                         
                   
				   <?php 
				   ++$vehicle_image_count;
				   }//end for loop 
				      
					  
					  ?>
                   
                   
                 
 <?php

$Query  = "Select * From receipt Where vecid = '".$_REQUEST['vehicle_id']."' and email= '".$_REQUEST['email']."' ORDER BY  `rec_id` DESC ";
$qry = mysql_query($Query); 
$num_rows = mysql_num_rows($qry);
// start of checking receipts exits
if ($num_rows>0){
	
	
$number=1;
$start_page=$vehicle_image_count+1;
?>
 <div style="width: 95%; margin: auto; text-align:center;  page-break-after: always;">
 <div style="margin:0 auto; font-family:Arial, Helvetica, sans-serif; font-size:24px;"><h1>Index of Receipts</h1></div> 
 <table width="94%" align="center" style="font-size:20px; font-weight:500;">
 
<?php
while ($row = mysql_fetch_array($qry))  
{
?>
 <tr>
 <td width="20">
<?php 
echo $number.'. ';
?>
 </td>
 
 <td width="470">
<?php
if($row["service_date"]){
  echo $row["service_date"];
}

if($row["service_date"]&&$row["nickname"]){
  echo ' | ';
}

if($row["nickname"]){
  echo htmlspecialchars($row["nickname"]);
}

if($row["nickname"]&&$row["milage"]){
  echo ' | ';
}

if($row["milage"]){
  echo 'Miles '.$row["milage"];
}

if($row["milage"]&&$row["shop"]){
  echo ' | ';
}

if($row["shop"]){
  echo htmlspecialchars($row["shop"]);
}
?>
</td>
<td width="100">
<?php
						   
						         $imageids=$row['receipt'];	
								 $imgids=array();
								 $imgids2 = explode(',',$imageids);
								
								if($number==1){
									 if( count($imgids2) > 1 )
										   {
											  $imgids = explode(',',$imageids);
											  
											  $start_page=$start_page;
											  $end_page=$start_page+count($imgids2)-1;
										   }
										   else
										   {
											   
											  $imgids[0] = $result_vehicle['image']; 
											  $start_page=$start_page;
											  $end_page='';
										   
										   }
								 
									
									
									}else{
										   if( count($imgids2) > 1 )
										   {
											  $imgids = explode(',',$imageids);
											  
											  $start_page=$new+1;
											  $end_page=$new+count($imgids2);
										   }
										   else
										   {
											   
											  $imgids[0] = $result_vehicle['image']; 
											  $start_page=$new+1;
											  $end_page='';
										   
										   }
								 
						            	}
								 if($end_page){		
								echo  $pages_at=$start_page.' - '.$end_page;
								  $new=$end_page;
								  }else{
								echo	  $pages_at=$start_page;
								      $new=$start_page;
									  }
								 ?>
 
 
</td>
</tr>

<?php
++$number; }
?>    
</table>                  
                  
       
 
</div>

<?php 
$qry2 = mysql_query($Query); 
$num_rows = mysql_num_rows($qry2);
$number=1;
while ($row2 = mysql_fetch_array($qry2))  
{
?> 
 
<div style="width: 95%; text-align:center; margin: 10px auto 30px; <?php if($num_rows!=$number){?>page-break-after:always;<?php } ?>">

 <div style="text-align:left;  font-family:Arial, Helvetica, sans-serif; font-size:24px;">
 <?php 
echo $number.'. ';
if($row2["service_date"]){
  echo $row2["service_date"];
}

if($row2["service_date"]&&$row2["nickname"]){
  echo ' | ';
}

if($row2["nickname"]){
  echo htmlspecialchars($row2["nickname"]);
}

if($row2["nickname"]&&$row2["milage"]){
  echo ' | ';
}

if($row2["milage"]){
  echo 'Miles '.$row2["milage"];
}

if($row2["milage"]&&$row2["shop"]){
  echo ' | ';
}

if($row2["shop"]){
  echo htmlspecialchars($row2["shop"]);
}
?>
 </div>
 
 <div style="text-align:left;">
 
 
 <?php           
  error_reporting(0);                      
  $method="aes-256-cbc";
  $key=12548693601;
  $details1 = openssl_decrypt($row2["details"], $method, $key);
  $details1 = htmlspecialchars_decode($details1);
  $details1 = stripcslashes($details1); 
  $details1 = str_replace("\'","'",$details1);
  $details1 = str_replace("\\\\","\\",$details1);					
  echo $details1;
  ?>
 </div>
<?php
						   
						         $imageids=$row2["receipt"];	
								 $imgids=array();
								 $imgids2 = explode(',',$imageids);
								 
								 if( count($imgids2) > 1 )
								 {
								    $imgids = explode(',',$imageids);
								 
								 }
								 else
								 {
									 
									$imgids[0] = $row2["receipt"]; 
								 }
								 
								
								 $receipt_image_count=1;
									for($i=0;$i<count($imgids);$i++){
								
								    $fetch_images = mysql_query("SELECT  image.imagefile as image, image.Image_url as image_url, image.location as file_location 	FROM image  where Image_id= '$imgids[$i]'");
									 $row_image = mysql_fetch_array( $fetch_images ); 
									  $Image_Id=$imgids[$i];
									  $image=$row_image['image'];
									  $img_url=$row_image['image_url'];
								      $file_loc=$row_image['file_location'];
									 
									 if($image!=''||$img_url!=''||$file_loc!=''){
                                              $method="aes-256-cbc";
											  $key=12548693601;											  
																					
											  $decrypted = openssl_decrypt($image, $method, $key);
											  $decoded=base64_decode($decrypted);		
											  
											  $final_location = '../'.$img_url;
											  
											  file_put_contents($final_location, $decoded);

									          $final_location=$final_location;
											 
											 //start updating fetched images table
											 $query_result = mysql_query("SELECT * FROM Fetched_Image WHERE Image_Id=$Image_Id");
											 if($query_result){
												if (!mysql_num_rows($query_result))
												{
												   $tm = time();
												   mysql_query("INSERT INTO Fetched_Image (Image_Id, Image_Url, Time, location) VALUES ('$Image_Id ','$img_url ', $tm, '$file_loc')");
											  
												}
											 }// end updating fetched images table
											 
									 }else{
									 $final_location="../img/dollarbig.png";
									 }
									 ?>
						                         
                                <?php if(count($imgids) > 1){ ?> 
                      
									  <?php if($receipt_image_count == 1){ ?> 
                                      <div style="width: 95%; margin: auto; <?php if($num_rows==$number){?>page-break-after:always;<?php } ?>">
                                       <table cellpadding="0" cellspacing="0" align="center" width="100%"  style="height:700px;">
                     <tr>
                     <td valign="middle" align="center"> 
                                <div style="margin: auto;">
                                      <img  style="margin-top:80px;" src="<?php echo $final_location; ?>" border="0"  />
                                </div> 
                                     </td>
                         </tr>
                         </table>
                                     </div>
                                     <?php } ?>
                                     
                                     <?php if($receipt_image_count > 1&&$receipt_image_count < count($imgids)){ ?> 
                            <div style="width: 95%; margin: auto; text-align:center;  page-break-after: always;">
             <table cellpadding="0" cellspacing="0" align="center" width="100%" style="height:700px;">
                     <tr>
                     <td valign="middle" align="center"> 
            <div style="margin: auto; text-align:left;"><?php echo $number .'. Continue..'.'';  ?></div>
            <div style="margin: auto;"><img  style="margin-top:80px;" src="<?php echo $final_location; ?>"  border="0"  /></div>                    </td>
                     </tr>
        </table>
       </div>
                        
                                     <?php } ?>
                                     
                                     
                                     <?php if($receipt_image_count > 1&&$receipt_image_count == count($imgids)){ ?>  
                    
  <div style="width: 95%; margin: auto; text-align:center;  <?php if($num_rows!=$number){?>page-break-after:always;<?php } ?>">        <table cellpadding="0" cellspacing="0" align="center" width="100%" style="height:820px;">
                     <tr>
                     <td valign="middle" align="center"> 
        
        <div style="margin:0 auto;"><p style="margin: auto; text-align:left;"><?php echo $number .'. Continue..'.'';  ?></p>
        <img  style="margin-top:80px;" src="<?php echo $final_location; ?>"  border="0"  /></div>
                     </td>
                     </tr>
        </table>
  </div>
                                     
                                     <?php } ?>
                                     
                              
                                    
                     <?php }else if(count($imgids) == 1||count($imgids)==0){  ?>
                     <table cellpadding="0" cellspacing="0" width="100%" align="center" style="height:700px;">
                     <tr>
                    
                     <td valign="middle" align="center">
									<div style="margin:0 auto; text-align:center;"><img src="<?php echo $final_location; ?>"  border="0"  /></div> 
                         </td>
                         </tr>
                         </table>
                                    </div>
					 <?php }?>   
                         
                   
				   <?php 
				   ++$receipt_image_count;
				   }//end for loop 
				   ?>

<?php
++$number; }
?>          



<?php } // end of checking receipts exits?>

</body>
</html>